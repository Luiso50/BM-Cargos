<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Envíos</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f9;
      background: #eef2f7;
      margin: 0;
      padding: 40px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .main-container {
      display: flex;
      gap: 20px; /* Espacio entre los botones y el formulario */
      align-items: flex-start;
    }
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .btn-square {
      width: 60px;
      height: 60px;
      background: #0078d7;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.3s ease;
    }
    .btn-square:hover {
      background: #005a9e;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      padding: 30px;
      width: 500px; /* Ancho ampliado */
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.15);
    }
    h2 {
      margin-top: 0;
      color: #0078d7;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: #333;
    }
    .inline-fields {
      display: flex;
      gap: 10px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    input:focus, select:focus {
      border-color: #0078d7;
      outline: none;
      box-shadow: 0 0 4px rgba(0,120,215,0.3);
    }
    .hidden {
      display: none;
    }
    button[type="submit"] {
      margin-top: 25px;
      width: 100%;
      padding: 12px;
      background: #0078d7;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    button[type="submit"]:hover {
      background: #005a9e;
    }
    .resumen {
      margin-top: 25px;
      padding: 15px;
      background: #f9fafc;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .resumen h3 {
      margin-top: 0;
      color: #444;
    }
    #iniciales, #inicialesValija {
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="button-container">
      <button class="btn-square" onclick="modificarRegistro()">MR</button>
      <button class="btn-square" onclick="borrarRegistro()">BR</button>
      <button class="btn-square" onclick="buscarGuia()">BG</button>
      <button class="btn-square" onclick="eliminarGuia()">EG</button>
    </div>
    <div class="card">
      <h2>Formulario de Envíos</h2>
      <form id="formEnvio">
        <label for="guia">No. de Guía</label>
        <input type="text" id="guia" name="guia" required>

        <label for="tipo">Tipo de Envío</label>
        <select id="tipo" name="tipo" required>
          <option value="">Seleccione...</option>
          <option value="valija">Valija</option>
          <option value="pallet">Pallet</option>
          <option value="dcontainer">D Container</option>
          <option value="uld">U. L. D.</option>
          <option value="piezas">Piezas</option>
        </select>

        <!-- Campos Valija -->
        <div id="valijaFields" class="hidden">
          <label for="numValija">Número de Valija</label>
          <input type="text" id="numValija" name="numValija">

          <label for="pesoValija">Peso (kg)</label>
          <input type="number" id="pesoValija" name="pesoValija" step="0.01" min="0">

          <label for="sello">Número de Sello</label>
          <input type="text" id="sello" name="sello">

          <label for="warehouse">Cantidad de Warehouse</label>
          <input type="number" id="warehouse" name="warehouse" min="0">

          <label for="inicialesValija">Iniciales (2 letras)</label>
          <input type="text" id="inicialesValija" name="inicialesValija" maxlength="2">
        </div>

        <!-- Campos Pallet / Piezas -->
        <div id="palletPiezasFields" class="hidden">
          <label for="numPallet">Número de Pallet</label>
          <input type="text" id="numPallet" name="numPallet">

          <label for="peso">Peso (kg)</label>
          <input type="number" id="peso" name="peso" step="0.01" min="0" style="width: 100%;">

         <div class="inline-fields">
            <div><label for="largo">Largo (in)</label>
            <input type="number" id="largo" name="largo" min="0" style="width: 90px;"></div>

            <div><label for="ancho">Ancho (in)</label>
            <input type="number" id="ancho" name="ancho" min="0" style="width: 90px;"></div>

           <div> <label for="altura">Altura (in)</label>
            <input type="number" id="altura" name="altura" min="0" style="width: 90px;"></div>
          </div>

          <label for="warehouse_pallet">Cantidad de Warehouse</label>
          <input type="number" id="warehouse_pallet" name="warehouse_pallet" min="0">

          <label for="iniciales">Iniciales (2 letras)</label>
          <input type="text" id="iniciales" name="iniciales" maxlength="2">
        </div>

        <button type="submit">Enviar</button>
      </form>

      <div id="resumen-container" class="resumen hidden">
        <div id="resumen"></div>
        <button id="generarPdfBtn" class="hidden">Generar PDF</button>
      </div>
    </div>
  </div>

  <!-- Librerías para generar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <script>
    const tipoSelect = document.getElementById('tipo');
    const valijaFields = document.getElementById('valijaFields');
    const palletPiezasFields = document.getElementById('palletPiezasFields');
    const form = document.getElementById('formEnvio');
    const resumenDiv = document.getElementById('resumen');
    const resumenContainer = document.getElementById('resumen-container');
    const generarPdfBtn = document.getElementById('generarPdfBtn');
    const guiaInput = document.getElementById('guia');
    const submitButton = form.querySelector('button[type="submit"]');

    let envios = {};
    let indiceItemEnEdicion = null; // Para saber qué item estamos editando

    const logoBM = "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... [truncated]";

    // Funciones para los nuevos botones
    function modificarRegistro() {
      const guia = guiaInput.value.trim();
      if (!guia || !envios[guia] || envios[guia].length === 0) {
        alert("No hay registros en la guía actual para modificar.");
        return;
      }

      const itemNum = prompt("Ingrese el número de envío que desea modificar:");
      if (!itemNum) return;

      const indice = envios[guia].findIndex(item => item.numPallet === itemNum || item.numValija === itemNum);

      if (indice === -1) {
        alert("No se encontró ningún item con ese número en la guía actual.");
        return;
      }

      indiceItemEnEdicion = indice;
      const item = envios[guia][indice];

      // Cargar datos en el formulario
      form.reset(); // Limpiar formulario antes de cargar
      guiaInput.value = guia; // Restaurar el número de guía

      for (const key in item) {
        if (form.elements[key]) {
          form.elements[key].value = item[key];
        }
      }
      
      // Mostrar los campos correctos según el tipo
      tipoSelect.dispatchEvent(new Event('change'));
      
      submitButton.textContent = 'Actualizar'; // Cambiar texto del botón
      window.scrollTo(0, 0); // Subir al inicio del formulario
    }

    function borrarRegistro() {
      const guia = guiaInput.value.trim();
      if (!guia || !envios[guia] || envios[guia].length === 0) {
        alert("No hay registros en la guía actual para borrar.");
        return;
      }

      const itemNum = prompt("Ingrese el número de envío que desea borrar:");
      if (!itemNum) return;

      const indice = envios[guia].findIndex(item => item.numPallet === itemNum || item.numValija === itemNum);

      if (indice === -1) {
        alert("No se encontró ningún item con ese número en la guía actual.");
        return;
      }

      const itemParaBorrar = envios[guia][indice];
      const confirmacion = confirm(`¿Está seguro de que desea borrar el item "${itemParaBorrar.numPallet || itemParaBorrar.numValija}"?`);

      if (confirmacion) {
        envios[guia].splice(indice, 1);
        actualizarResumen(guia);
        saveData();
        alert("Registro borrado exitosamente.");
      }
    }

    function buscarGuia() {
      const guiasGuardadas = Object.keys(envios);
      if (guiasGuardadas.length === 0) {
        alert("No hay guías guardadas para buscar.");
        return;
      }

      const ultimasDiez = guiasGuardadas.slice(-10).reverse();
      const mensaje = "Últimas 10 guías guardadas:\n\n" + ultimasDiez.join("\n") + "\n\nIngrese el número de la guía que desea cargar:";

      const guiaSeleccionada = prompt(mensaje);

      if (guiaSeleccionada && envios[guiaSeleccionada]) {
        guiaInput.value = guiaSeleccionada;
        // Disparar el evento 'input' para que se actualice el resumen
        guiaInput.dispatchEvent(new Event('input'));
      } else if (guiaSeleccionada) {
        alert("El número de guía ingresado no existe.");
      }
    }

    function eliminarGuia() {
      const guiaAEliminar = prompt("Ingrese el número de la guía que desea eliminar por completo:");

      if (!guiaAEliminar) return;

      if (envios[guiaAEliminar]) {
        const confirmacion = confirm(`¿Está seguro de que desea eliminar permanentemente la guía "${guiaAEliminar}" y todos sus registros? Esta acción no se puede deshacer.`);

        if (confirmacion) {
          delete envios[guiaAEliminar];
          saveData();

          // Si la guía eliminada era la que se estaba mostrando, limpiar la vista
          if (guiaInput.value === guiaAEliminar) {
            form.reset();
            resumenDiv.innerHTML = '';
            resumenContainer.classList.add('hidden');
          }

          alert(`La guía "${guiaAEliminar}" ha sido eliminada.`);
        }
      } else {
        alert("No se encontró ninguna guía con ese número.");
      }
    }

    function saveData() {
      localStorage.setItem('enviosData', JSON.stringify(envios));
    }

    function loadData() {
      const data = localStorage.getItem('enviosData');
      if (data) {
        envios = JSON.parse(data);
        const lastGuia = Object.keys(envios).pop();
        if(lastGuia){
            guiaInput.value = lastGuia;
            actualizarResumen(lastGuia);
            resumenContainer.classList.remove('hidden');
        }
      }
    }

    window.addEventListener('load', loadData);

    function generarPDF() {
      const guia = guiaInput.value.trim();
      if (!guia || !envios[guia] || envios[guia].length === 0) {
        alert("No hay datos en la guía actual para generar un informe.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageHeight = doc.internal.pageSize.height;
      let finalY = 0;

      // --- 1. ENCABEZADO --- 
      function agregarEncabezado(doc, titulo = "CONTROL DE VALIJAS") {
        doc.addImage(logoBM, 'JPEG', 14, 15, 40, 15);
        doc.setFont('Arial', 'bold');
        doc.setFontSize(16);
        doc.text("ATALLAH BUSINES GROUP INC", doc.internal.pageSize.width / 2, 20, { align: 'center' });

        doc.setFont('Arial', 'normal');
        doc.setFontSize(10);
        doc.text("8400 NW 25 TH STREET SUIT 100 MIAMI FL 33198", doc.internal.pageSize.width / 2, 27, { align: 'center' });
        
        doc.setFont('Arial', 'bold');
        doc.setFontSize(12);
        doc.text(titulo, doc.internal.pageSize.width / 2, 35, { align: 'center' });

        doc.setFont('Arial', 'normal');
        doc.setFontSize(10);
        const fecha = new Date().toLocaleDateString();
        doc.text(`AWB #: ${guia}`, 14, 45);
        doc.text(fecha, doc.internal.pageSize.width - 14, 45, { align: 'right' });
      }

      agregarEncabezado(doc, "CONTROL DE VALIJAS");

      // --- 2. PÁGINA DE VALIJAS ---
      const valijas = envios[guia].filter(e => e.tipo === 'valija').sort((a, b) => {
        return (a.numValija || '').localeCompare(b.numValija || '', undefined, { numeric: true });
      });

      if (valijas.length > 0) {
        const tableColumn = ["#", "# Pieza", "Cant Warehouse", "No Sello"];
        const rowsLeft = [];
        const rowsRight = [];

        for (let i = 0; i < 25; i++) {
          const valija = valijas[i];
          rowsLeft.push([ i + 1, valija?.numValija || '', valija?.warehouse || '', valija?.sello || '' ]);
        }
        for (let i = 25; i < 50; i++) {
          const valija = valijas[i];
          rowsRight.push([ i + 1, valija?.numValija || '', valija?.warehouse || '', valija?.sello || '' ]);
        }

        doc.autoTable(tableColumn, rowsLeft, {
          startY: 55,
          theme: 'grid',
          headStyles: { fillColor: [0, 123, 255], textColor: 255, fontStyle: 'bold' },
          styles: { font: 'Arial', fontSize: 9, cellPadding: 2 },
          margin: { right: doc.internal.pageSize.width / 2 + 2 }
        });

        doc.autoTable(tableColumn, rowsRight, {
          startY: 55,
          theme: 'grid',
          headStyles: { fillColor: [0, 123, 255], textColor: 255, fontStyle: 'bold' },
          styles: { font: 'Arial', fontSize: 9, cellPadding: 2 },
          margin: { left: doc.internal.pageSize.width / 2 + 2 }
        });

        finalY = doc.lastAutoTable.finalY > finalY ? doc.lastAutoTable.finalY : finalY;
      }

      // --- 3. PÁGINA DE TODOS LOS ENVÍOS ---
      const todosLosEnvios = [...envios[guia]].sort((a, b) => {
        const itemA = a.numPallet || a.numValija || 'Z';
        const itemB = b.numPallet || b.numValija || 'Z';
        return itemA.localeCompare(itemB, undefined, { numeric: true });
      });

      if (todosLosEnvios.length > 0) {
        doc.addPage();
        agregarEncabezado(doc, "LOCALIZACION CARGA EXPRESS Y PRIORITY");
        
        const tableColumn = ["#", "No. Envio", "Descripcion", "Largo", "Ancho", "Alto", "Volumen", "Peso", "Inicial"];
        const tableRows = [];

        todosLosEnvios.forEach((envio, index) => {
            const volumen = (envio.altura && envio.ancho && envio.largo)
                ? Math.floor((parseFloat(envio.altura) * parseFloat(envio.ancho) * parseFloat(envio.largo)) / 366)
                : '';

            const rowData = [
                index + 1,
                envio.numPallet || envio.numValija || '',
                envio.tipo || '',
                envio.largo || '',
                envio.ancho || '',
                envio.altura || '',
                volumen,
                envio.peso || envio.pesoValija || '',
                envio.iniciales || envio.inicialesValija || ''
            ];
            tableRows.push(rowData);
        });

        doc.autoTable(tableColumn, tableRows, {
          startY: 55,
          theme: 'grid',
          headStyles: { fillColor: [0, 123, 255], textColor: 255, fontStyle: 'bold' },
          styles: { font: 'Arial', fontSize: 9 }
        });
        finalY = doc.lastAutoTable.finalY;
      }

      // --- 4. PÁGINA DE RESUMEN ---
      doc.addPage();
      // Custom Header for Summary Page
      doc.setFont('Arial', 'bold');
      doc.setFontSize(16);
      doc.text("ATALLAH BUSINES GROUP INC", doc.internal.pageSize.width / 2, 20, { align: 'center' });

      doc.setFont('Arial', 'normal');
      doc.setFontSize(10);
      doc.text("8400 NW 25 TH STREET SUIT 100 MIAMI FL 33198", doc.internal.pageSize.width / 2, 27, { align: 'center' });
      
      doc.setFont('Arial', 'bold');
      doc.setFontSize(12);
      doc.text("BM CARGOS WAREHOUSE", doc.internal.pageSize.width / 2, 35, { align: 'center' });
      doc.setFontSize(10);
      doc.text("(305) 593 5383", doc.internal.pageSize.width / 2, 40, { align: 'center' });

      doc.setFont('Arial', 'normal');
      const fecha = new Date().toLocaleDateString();
      doc.text(`AWB #: ${guia}`, 14, 45);
      doc.text(fecha, doc.internal.pageSize.width - 14, 45, { align: 'right' });

      // --- Totals Calculation ---
      let totalPeso = 0, totalValijas = 0, totalPiezas = 0, totalDContainers = 0, totalULDs = 0, totalVolumen = 0, totalWarehouse = 0;
      for (const envio of envios[guia]) {
        totalPeso += parseFloat(envio.peso || envio.pesoValija || 0);
        if (envio.tipo === 'valija') totalValijas++;
        else if (envio.tipo === 'piezas') totalPiezas++;
        else if (envio.tipo === 'dcontainer') totalDContainers++;
        else if (envio.tipo === 'uld') totalULDs++;
        if (envio.altura && envio.ancho && envio.largo) {
            const vol = Math.floor((parseFloat(envio.altura) * parseFloat(envio.ancho) * parseFloat(envio.largo)) / 366);
            totalVolumen += vol;
        }
        totalWarehouse += parseInt(envio.warehouse || envio.warehouse_pallet || 0, 10);
      }
      const totalPaquetes = envios[guia].length;

      // --- New Summary Layout ---
      const startY = 65;
      const startX = 14;
      const valueX = 80;
      const lineSpacing = 10; // Increased line spacing
      let currentY = startY;

      function drawUnderlinedText(doc, text, x, y) {
          const textString = String(text);
          const textWidth = doc.getTextWidth(textString);
          doc.text(textString, x, y);
          doc.line(x, y + 1, x + textWidth, y + 1);
      }

      doc.setFont('Arial', 'bold');
      doc.setFontSize(12);

      doc.text("D Container", startX, currentY);
      drawUnderlinedText(doc, String(totalDContainers), valueX, currentY);
      currentY += lineSpacing;

      doc.text("U.L.D.", startX, currentY);
      drawUnderlinedText(doc, String(totalULDs), valueX, currentY);
      doc.text("SEAL", valueX + 40, currentY);
      drawUnderlinedText(doc, "0", valueX + 60, currentY);
      currentY += lineSpacing;

      doc.text("PCS", startX, currentY);
      drawUnderlinedText(doc, String(totalPiezas), valueX, currentY);
      currentY += lineSpacing;

      doc.text("BAGS", startX, currentY);
      drawUnderlinedText(doc, String(totalValijas), valueX, currentY);
      currentY += lineSpacing;
      
      doc.text("CREATE", startX, currentY);
      drawUnderlinedText(doc, "0", valueX, currentY);
      currentY += lineSpacing;

      doc.text("TOTAL", startX, currentY);
      drawUnderlinedText(doc, String(totalPaquetes), valueX, currentY);
      
      currentY += lineSpacing * 1.8; // Extra space

      doc.text("PESO TOTAL", startX, currentY);
      drawUnderlinedText(doc, totalPeso.toFixed(2) + " kg", valueX, currentY);
      currentY += lineSpacing;

      doc.text("VOLUMEN TOTAL", startX, currentY);
      drawUnderlinedText(doc, String(totalVolumen), valueX, currentY);
      currentY += lineSpacing;

      doc.text("CANTIDAD TOTAL DE WR", startX, currentY);
      drawUnderlinedText(doc, String(totalWarehouse), valueX, currentY);

      // --- SAVE PDF ---
      doc.save(`Informe-Guia-${guia}.pdf`);
    }

    function actualizarResumen(guia) {
      if (!guia || !envios[guia] || envios[guia].length === 0) {
        resumenDiv.innerHTML = '';
        generarPdfBtn.classList.add('hidden');
        resumenContainer.classList.add('hidden');
        return;
      };

      let totalPeso = 0, totalPallets = 0, totalValijas = 0, totalPiezas = 0, totalDContainers = 0, totalULDs = 0, totalVolumen = 0, totalWarehouse = 0;

      for (const envio of envios[guia]) {
        if (envio.tipo === 'valija' && envio.pesoValija) totalPeso += parseFloat(envio.pesoValija);
        else if (['pallet', 'piezas', 'dcontainer', 'uld'].includes(envio.tipo) && envio.peso) totalPeso += parseFloat(envio.peso);

        if (envio.tipo === 'valija') totalValijas++;
        else if (envio.tipo === 'pallet') totalPallets++;
        else if (envio.tipo === 'piezas') totalPiezas++;
        else if (envio.tipo === 'dcontainer') totalDContainers++;
        else if (envio.tipo === 'uld') totalULDs++;

        if (['pallet', 'piezas', 'dcontainer', 'uld'].includes(envio.tipo) && envio.altura && envio.ancho && envio.largo) {
          const alto = parseFloat(envio.altura), ancho = parseFloat(envio.ancho), largo = parseFloat(envio.largo);
          if (alto > 0 && ancho > 0 && largo > 0) totalVolumen += Math.floor((alto * ancho * largo) / 366);
        }

        totalWarehouse += parseInt(envio.warehouse, 10) || 0;
        totalWarehouse += parseInt(envio.warehouse_pallet, 10) || 0;
      }

      resumenDiv.innerHTML = `
        <h3>Resumen para Guía: ${guia}</h3>
        <ul>
          <li><b>Peso Total:</b> ${totalPeso.toFixed(2)} kg</li>
          <li><b>Cantidad de Pallets:</b> ${totalPallets}</li>
          <li><b>Cantidad de Valijas:</b> ${totalValijas}</li>
          <li><b>Cantidad de Piezas:</b> ${totalPiezas}</li>
          <li><b>Cantidad de D Containers:</b> ${totalDContainers}</li>
          <li><b>Cantidad de U.L.D.s:</b> ${totalULDs}</li>
          <li><b>Volumen Total:</b> ${totalVolumen}</li>
          <li><b>Cantidad Total de Warehouse:</b> ${totalWarehouse}</li>
        </ul>
      `;
      generarPdfBtn.classList.remove('hidden');
      resumenContainer.classList.remove('hidden');
    }

    tipoSelect.addEventListener('change', () => {
      const selectedType = tipoSelect.value;
      valijaFields.classList.toggle('hidden', selectedType !== 'valija');
      palletPiezasFields.classList.toggle('hidden', !['pallet', 'piezas', 'dcontainer', 'uld'].includes(selectedType));
    });

    guiaInput.addEventListener('input', (e) => {
        const guia = e.target.value.trim();
        resumenContainer.classList.toggle('hidden', !guia);
        indiceItemEnEdicion = null; // Resetear modo edición al cambiar de guía
        submitButton.textContent = 'Enviar';
        if(guia){
            actualizarResumen(guia);
        } else {
            resumenDiv.innerHTML = '';
            generarPdfBtn.classList.add('hidden');
        }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      let inicialesInput;
      if (tipoSelect.value === 'valija') {
        inicialesInput = document.getElementById('inicialesValija');
      } else if (['pallet', 'piezas', 'dcontainer', 'uld'].includes(tipoSelect.value)) {
        inicialesInput = document.getElementById('iniciales');
      }

      if (inicialesInput) {
        const inicialesValue = inicialesInput.value.trim().toUpperCase();
        if (!/^[A-Z]{2}$/.test(inicialesValue)) {
          alert("Las iniciales deben ser exactamente 2 letras mayúsculas.");
          inicialesInput.focus();
          return;
        }
        inicialesInput.value = inicialesValue;
      }

      const formData = new FormData(form);
      const envio = Object.fromEntries(formData.entries());
      const guia = envio.guia;

      if (indiceItemEnEdicion !== null) {
        // MODO EDICIÓN: Actualizar el item existente
        envios[guia][indiceItemEnEdicion] = envio;
      } else {
        // MODO CREACIÓN: Validar y agregar nuevo item
        const numeroEnvio = envio.numPallet || envio.numValija;
        if (numeroEnvio && envios[guia]) {
          const esDuplicado = envios[guia].some(item => item.numPallet === numeroEnvio || item.numValija === numeroEnvio);
          if (esDuplicado) {
            alert(`Error: El número de envío '${numeroEnvio}' ya existe en esta guía.`);
            return; // Detener el proceso
          }
        }

        if (!envios[guia]) {
          envios[guia] = [];
        }
        envios[guia].push(envio);
      }

      actualizarResumen(guia);
      saveData();

      // Resetear estado de edición y formulario
      indiceItemEnEdicion = null;
      submitButton.textContent = 'Enviar';
      const guiaValue = guiaInput.value;
      form.reset();
      guiaInput.value = guiaValue;

      valijaFields.classList.add('hidden');
      palletPiezasFields.classList.add('hidden');
      resumenContainer.classList.remove('hidden');
    });

    generarPdfBtn.addEventListener('click', generarPDF);
  </script>
</body>
</html>